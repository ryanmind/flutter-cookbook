# Flutter 国际化 - 初学者指南

## 目录
1. [国际化基础](#国际化基础)
2. [使用 intl 包](#使用-intl-包)
3. [多语言实现](#多语言实现)
4. [日期与数字格式化](#日期与数字格式化)
5. [动态切换语言](#动态切换语言)

## 国际化基础

### 添加依赖

```yaml
# pubspec.yaml
dependencies:
  flutter_localizations:
    sdk: flutter
  intl: ^0.18.0
```

### MaterialApp 配置

```dart
import 'package:flutter_localizations/flutter_localizations.dart';

MaterialApp(
  localizationsDelegates: [
    AppLocalizations.delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
    GlobalCupertinoLocalizations.delegate,
  ],
  supportedLocales: [
    Locale('en', 'US'),
    Locale('zh', 'CN'),
    Locale('ja', 'JP'),
  ],
  locale: Locale('zh', 'CN'),  // 指定默认语言
);
```

## 使用 intl 包

### 初始化

```yaml
# pubspec.yaml
dependencies:
  intl: ^0.18.0

flutter:
  generate: true  # 启用代码生成
```

创建 `l10n.yaml` 配置文件：

```yaml
arb-dir: lib/l10n
template-arb-file: app_en.arb
output-localization-file: app_localizations.dart
```

### 创建 ARB 文件

`lib/l10n/app_en.arb`:
```json
{
  "@@locale": "en",
  "appTitle": "My App",
  "@appTitle": {
    "description": "The title of the application"
  },
  "hello": "Hello",
  "@hello": {
    "description": "Greeting message"
  },
  "helloUser": "Hello, {name}!",
  "@helloUser": {
    "description": "Greeting with user name",
    "placeholders": {
      "name": {
        "type": "String",
        "example": "John"
      }
    }
  },
  "itemCount": "{count, plural, =0{No items} =1{1 item} other{{count} items}}",
  "@itemCount": {
    "description": "Number of items",
    "placeholders": {
      "count": {
        "type": "int",
        "format": "compact"
      }
    }
  }
}
```

`lib/l10n/app_zh.arb`:
```json
{
  "@@locale": "zh",
  "appTitle": "我的应用",
  "hello": "你好",
  "helloUser": "你好，{name}！",
  "itemCount": "{count, plural, =0{没有项目} other{{count} 个项目}}"
}
```

### 生成代码

```bash
flutter gen-l10n
```

### 使用生成的本地化

```dart
import 'package:flutter_gen/gen_l10n/app_localizations.dart';

class MyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    
    return Column(
      children: [
        Text(l10n.appTitle),
        Text(l10n.hello),
        Text(l10n.helloUser('张三')),
        Text(l10n.itemCount(5)),
      ],
    );
  }
}
```

## 多语言实现

### 手动实现本地化

```dart
// 语言基类
abstract class AppTranslations {
  Locale get locale;
  
  String get appTitle;
  String get hello;
  String get settings;
  String get cancel;
  String get confirm;
  String get save;
  String get delete;
  String helloUser(String name);
}

// 英文实现
class EnglishTranslations extends AppTranslations {
  @override
  Locale get locale => Locale('en', 'US');
  
  @override
  String get appTitle => 'My App';
  
  @override
  String get hello => 'Hello';
  
  @override
  String get settings => 'Settings';
  
  @override
  String get cancel => 'Cancel';
  
  @override
  String get confirm => 'Confirm';
  
  @override
  String get save => 'Save';
  
  @override
  String get delete => 'Delete';
  
  @override
  String helloUser(String name) => 'Hello, $name!';
}

// 中文实现
class ChineseTranslations extends AppTranslations {
  @override
  Locale get locale => Locale('zh', 'CN');
  
  @override
  String get appTitle => '我的应用';
  
  @override
  String get hello => '你好';
  
  @override
  String get settings => '设置';
  
  @override
  String get cancel => '取消';
  
  @override
  String get confirm => '确认';
  
  @override
  String get save => '保存';
  
  @override
  String get delete => '删除';
  
  @override
  String helloUser(String name) => '你好，$name！';
}
```

### 本地化代理

```dart
class AppLocalizationsDelegate extends LocalizationsDelegate<AppTranslations> {
  final Locale overriddenLocale;
  
  AppLocalizationsDelegate(this.overriddenLocale);
  
  @override
  bool isSupported(Locale locale) {
    return ['en', 'zh'].contains(locale.languageCode);
  }
  
  @override
  Future<AppTranslations> load(Locale locale) async {
    switch (locale.languageCode) {
      case 'zh':
        return ChineseTranslations();
      default:
        return EnglishTranslations();
    }
  }
  
  @override
  bool shouldReload(AppLocalizationsDelegate old) => false;
}
```

## 日期与数字格式化

### 日期格式化

```dart
import 'package:intl/intl.dart';
import 'package:intl/date_symbol_data_local.dart';

// 初始化日期格式化数据
await initializeDateFormatting('zh_CN', null);

// 日期格式化
final now = DateTime.now();

// 标准格式
print(DateFormat.yMd().format(now));        // 2026/02/19
print(DateFormat.yMMMMd().format(now));     // 2026年2月19日
print(DateFormat.yMMMd().format(now));      // 2026年2月19日

// 带时间
print(DateFormat.yMd().add_jm().format(now));     // 2026/02/19 3:30 PM
print(DateFormat.yMMMd().add_Hm().format(now));   // 2026年2月19日 15:30

// 相对时间
print(DateFormat('EEEE').format(now));      // 星期三
print(DateFormat('MMM').format(now));       // 2月

// 自定义格式
print(DateFormat('yyyy-MM-dd HH:mm:ss').format(now));  // 2026-02-19 15:30:00

// 解析日期
final date = DateFormat('yyyy-MM-dd').parse('2026-02-19');
```

### 数字格式化

```dart
import 'package:intl/intl.dart';

// 数字格式化
final number = 1234567.89;

// 标准数字
print(NumberFormat().format(number));           // 1,234,567.89

// 货币
print(NumberFormat.currency().format(number));  // USD1,234,567.89
print(NumberFormat.currency(
  locale: 'zh_CN',
  symbol: '¥',
).format(number));                              // ¥1,234,567.89

// 百分比
print(NumberFormat.percentPattern().format(0.75));  // 75%

// 紧凑数字
print(NumberFormat.compact().format(1234567));      // 1.2M
print(NumberFormat.compact(locale: 'zh_CN').format(1234567));  // 123万

// 小数位数
print(NumberFormat.decimalPattern().format(number));     // 1,234,567.89
print(NumberFormat.decimalPatternDigits(
  decimalDigits: 2,
).format(number));  // 1,234,567.89

// 科学计数法
print(NumberFormat.scientificPattern().format(number));  // 1.23456789E6
```

### 消息格式化

```dart
import 'package:intl/intl.dart';
import 'package:intl/message_lookup_by_library.dart';

// 复数形式
String itemCount(int count) {
  return Intl.plural(
    count,
    zero: 'No items',
    one: '1 item',
    other: '$count items',
    name: 'itemCount',
    args: [count],
  );
}

// 性别形式
String genderMessage(String gender, String name) {
  return Intl.gender(
    gender,
    male: '$name 先生',
    female: '$name 女士',
    other: '$name',
    name: 'genderMessage',
    args: [gender, name],
  );
}

// 选择形式
String selectMessage(String type) {
  return Intl.select(
    type,
    {
      'home': 'Home Page',
      'settings': 'Settings Page',
      'profile': 'Profile Page',
    },
    name: 'selectMessage',
    args: [type],
  );
}
```

## 动态切换语言

### 语言管理器

```dart
class LocaleProvider extends ChangeNotifier {
  Locale _locale = Locale('en', 'US');
  
  Locale get locale => _locale;
  
  static const List<Locale> supportedLocales = [
    Locale('en', 'US'),
    Locale('zh', 'CN'),
    Locale('ja', 'JP'),
  ];
  
  static const Map<String, Locale> localeMap = {
    'English': Locale('en', 'US'),
    '中文': Locale('zh', 'CN'),
    '日本語': Locale('ja', 'JP'),
  };
  
  void setLocale(Locale locale) {
    if (!supportedLocales.contains(locale)) return;
    _locale = locale;
    notifyListeners();
  }
  
  void setLocaleByLanguage(String language) {
    final locale = localeMap[language];
    if (locale != null) {
      setLocale(locale);
    }
  }
  
  String get currentLanguageName {
    return localeMap.entries
        .firstWhere((e) => e.value == _locale)
        .key;
  }
}
```

### 应用配置

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // 初始化日期格式化
  await initializeDateFormatting();
  
  runApp(
    ChangeNotifierProvider(
      create: (_) => LocaleProvider(),
      child: MyApp(),
    ),
  );
}

class MyApp extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final locale = ref.watch(localeProvider).locale;
    
    return MaterialApp(
      locale: locale,
      localizationsDelegates: [
        AppLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      supportedLocales: LocaleProvider.supportedLocales,
      home: HomePage(),
    );
  }
}
```

### 语言选择界面

```dart
class LanguageSettingsPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final localeProvider = ref.watch(localeProvider);
    final currentLocale = localeProvider.locale;
    
    return Scaffold(
      appBar: AppBar(title: Text('Language')),
      body: ListView(
        children: LocaleProvider.localeMap.entries.map((entry) {
          final isSelected = entry.value == currentLocale;
          
          return ListTile(
            title: Text(entry.key),
            subtitle: Text(entry.value.toString()),
            trailing: isSelected ? Icon(Icons.check) : null,
            onTap: () {
              ref.read(localeProvider.notifier).setLocale(entry.value);
              
              // 持久化语言设置
              SharedPreferences.getInstance().then((prefs) {
                prefs.setString('language', entry.value.languageCode);
              });
            },
          );
        }).toList(),
      ),
    );
  }
}
```

### 恢复语言设置

```dart
class LocaleProvider extends ChangeNotifier {
  Locale _locale = Locale('en', 'US');
  final SharedPreferences _prefs;
  
  LocaleProvider(this._prefs) {
    _loadSavedLocale();
  }
  
  void _loadSavedLocale() {
    final savedLanguage = _prefs.getString('language');
    if (savedLanguage != null) {
      final locale = supportedLocales.firstWhere(
        (l) => l.languageCode == savedLanguage,
        orElse: () => supportedLocales.first,
      );
      _locale = locale;
    }
  }
  
  // ...
}
```

## 完整示例

```dart
import 'package:flutter/material.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:intl/intl.dart';
import 'package:intl/date_symbol_data_local.dart';
import 'package:flutter_gen/gen_l10n/app_localizations.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await initializeDateFormatting();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Demo',
      localizationsDelegates: [
        AppLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      supportedLocales: [
        Locale('en'),
        Locale('zh'),
      ],
      home: HomePage(),
    );
  }
}

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    final now = DateTime.now();
    
    return Scaffold(
      appBar: AppBar(
        title: Text(l10n.appTitle),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(l10n.hello),
            Text(l10n.helloUser('Flutter')),
            Text(l10n.itemCount(5)),
            SizedBox(height: 20),
            Text(
              DateFormat.yMMMd(Localizations.localeOf(context).languageCode)
                  .format(now),
            ),
          ],
        ),
      ),
    );
  }
}
```

---

*最后更新: 2026-02-19*
